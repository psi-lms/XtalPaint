{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"XtalPaint \u2013 A framework for crystal structure inpainting based on diffusion models","text":"<p>Welcome to the <code>XtalPaint</code> Documentation.</p>"},{"location":"#overview","title":"Overview","text":"<p><code>XtalPaint</code> is a Python package that provides tools to perform crystal structure inpainting, i.e. adding atomic sites to a given host structure, using score-based diffusion models. Here, we provide retrained versions of the <code>Mattergen</code> architecture and the building blocks to set up the inpainting workflows. The initial application in our latest work: Score-based diffusion models for accurate crystal-structure inpainting and reconstruction of hydrogen positions, focuses on adding missing hydrogen sites to inorganic crystal structures, but the framework can be adapted to other inpainting tasks as well, i.e. general crystal structure prediction based on given host structures (see other interesting works in the field, e.g. by Zhong et al.).</p>"},{"location":"#features","title":"Features","text":"<ul> <li>Inpainting pipeline for crystal structures</li> <li>Integration with AiiDA workflow management</li> <li>Support for various relaxation methods</li> <li>Evaluation metrics for inpainting quality</li> </ul>"},{"location":"#getting-started","title":"Getting Started","text":"<p>Check out the examples on to run the inpainting pipeline:</p> <ul> <li>With AiiDA integration</li> <li>Without AiiDA integration</li> </ul>"},{"location":"#installation","title":"Installation","text":"<pre><code>git clone https://github.com/psi-lms/XtalPaint.git\ncd XtalPaint/\n\nuv pip install .\n</code></pre> <p>This will install the default version. If you want to use it in combination with AiiDA, please also install the optional dependencies:</p> <pre><code>uv pip install .[aiida]\n</code></pre>"},{"location":"#model-checkpoints-for-retrained-versions-of-mattergen","title":"Model checkpoints for retrained versions of MatterGen","text":"<p>Model checkpoints for the retrained versions of MatterGen used in our work can be downloaded from Hugging Face. Currently, the repository contains the <code>pos-only</code> and <code>TD-pos-only</code> models discussed in the paper.</p>"},{"location":"#acknowledgements","title":"Acknowledgements","text":"<p>This project is developed to perform crystal structure inpainting, currently on top of Microsoft's MatterGen. Some parts of the codebase are adapted from MatterGen's implementation (as highlighted in the respective files).</p>"},{"location":"examples/","title":"Examples of using the XtalPaint package","text":""},{"location":"examples/running-with-AiiDA/","title":"Running with AiiDA","text":"In\u00a0[1]: Copied! <pre>%load_ext aiida\n%aiida\n</pre> %load_ext aiida %aiida Out[1]: <p>Loaded AiiDA DB environment - profile name: presto.</p> In\u00a0[2]: Copied! <pre>from xtalpaint.aiida.workgraphs.inpainting import setup_inpainting_wg\nfrom xtalpaint.inpainting.config_schema import InpaintingWorkGraphConfig\nfrom xtalpaint.aiida.data import BatchedStructures\nfrom ase.io import read\nfrom pymatgen.io.ase import AseAtomsAdaptor\n</pre> from xtalpaint.aiida.workgraphs.inpainting import setup_inpainting_wg from xtalpaint.inpainting.config_schema import InpaintingWorkGraphConfig from xtalpaint.aiida.data import BatchedStructures from ase.io import read from pymatgen.io.ase import AseAtomsAdaptor <pre>MODELS_PROJECT_ROOT: /home/reents_t/project/dev-mattergen-inpainting/git/mattergen/mattergen\n</pre> In\u00a0[3]: Copied! <pre>structures = read(\"test-structures.extxyz\", index=':')\nstructures = {\n    a.info['uuid']: AseAtomsAdaptor.get_structure(a) for a in structures\n}\n</pre> structures = read(\"test-structures.extxyz\", index=':') structures = {     a.info['uuid']: AseAtomsAdaptor.get_structure(a) for a in structures } In\u00a0[4]: Copied! <pre>len(structures)\n</pre> len(structures) Out[4]: <pre>5</pre> In\u00a0[5]: Copied! <pre>param_grid = {\n    \"N_steps\": 5,\n    \"coordinates_snr\": 0.2,\n    \"n_corrector_steps\": 1,\n    \"batch_size\": 1000,\n}\n</pre> param_grid = {     \"N_steps\": 5,     \"coordinates_snr\": 0.2,     \"n_corrector_steps\": 1,     \"batch_size\": 1000, } In\u00a0[6]: Copied! <pre>ENV_ACTIVATION_CMD = \"source ~/.aiida_venvs/dev-mattergen-inpainting/bin/activate\"\n\ninputs = InpaintingWorkGraphConfig(\n    inpainting_pipeline_params={\n        \"predictor_corrector\": \"baseline\",\n        \"inpainting_model_params\": param_grid,\n        \"pretrained_name\": \"mattergen_base\",\n        \"sampling_config_path\": \"/home/reents_t/project/dev-mattergen-inpainting/git/mattergen/sampling_conf\",\n    },\n    structures=BatchedStructures(\n        {k.replace(\"-\", \"_\"): s for k, s in structures.items()}\n    ),\n    gen_inpainting_candidates_params={\n        \"n_inp\": {\n            k.replace(\"-\", \"_\"): int(s.composition[\"H\"])\n            for k, s in structures.items()\n        },\n        \"element\": \"H\",\n        \"num_samples\": 1,\n    },\n    relax=True,\n    full_relax=True,\n    full_relax_wo_pre_relax=False,\n    run_inpainting=True,\n    relax_kwargs={\n        \"elements_to_relax\": [\"H\"],\n        \"fmax\": 0.01,\n        \"max_natoms_per_batch\": 5000,\n        \"load_path\": \"MatterSim-v1.0.0-5M.pth\",\n        \"max_n_steps\": 50,\n        \"device\": \"cuda\",\n        \"mlip\": \"mattersim\",\n        \"optimizer\": \"BFGS\",\n        \"return_initial_energies\": False,\n        \"return_initial_forces\": False,\n        \"return_final_forces\": False,\n    },\n    gen_inpainting_candidates_options={\n        \"custom_scheduler_commands\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",\n    },\n    options={\n        \"prepend_text\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",\n    },\n    evaluate_params={\"max_workers\": 5, \"metrics\": [\"match\", \"rmsd\"]},\n    evaluate=True,\n)\n</pre> ENV_ACTIVATION_CMD = \"source ~/.aiida_venvs/dev-mattergen-inpainting/bin/activate\"  inputs = InpaintingWorkGraphConfig(     inpainting_pipeline_params={         \"predictor_corrector\": \"baseline\",         \"inpainting_model_params\": param_grid,         \"pretrained_name\": \"mattergen_base\",         \"sampling_config_path\": \"/home/reents_t/project/dev-mattergen-inpainting/git/mattergen/sampling_conf\",     },     structures=BatchedStructures(         {k.replace(\"-\", \"_\"): s for k, s in structures.items()}     ),     gen_inpainting_candidates_params={         \"n_inp\": {             k.replace(\"-\", \"_\"): int(s.composition[\"H\"])             for k, s in structures.items()         },         \"element\": \"H\",         \"num_samples\": 1,     },     relax=True,     full_relax=True,     full_relax_wo_pre_relax=False,     run_inpainting=True,     relax_kwargs={         \"elements_to_relax\": [\"H\"],         \"fmax\": 0.01,         \"max_natoms_per_batch\": 5000,         \"load_path\": \"MatterSim-v1.0.0-5M.pth\",         \"max_n_steps\": 50,         \"device\": \"cuda\",         \"mlip\": \"mattersim\",         \"optimizer\": \"BFGS\",         \"return_initial_energies\": False,         \"return_initial_forces\": False,         \"return_final_forces\": False,     },     gen_inpainting_candidates_options={         \"custom_scheduler_commands\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",     },     options={         \"prepend_text\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",     },     evaluate_params={\"max_workers\": 5, \"metrics\": [\"match\", \"rmsd\"]},     evaluate=True, ) In\u00a0[7]: Copied! <pre>wg = setup_inpainting_wg(\n    inputs\n)\n</pre> wg = setup_inpainting_wg(     inputs ) In\u00a0[8]: Copied! <pre>wg\n</pre> wg Out[8]: <pre>NodeGraphWidget(settings={'minimap': True}, style={'width': '90%', 'height': '600px'}, value={'name': 'WorkGra\u2026</pre> In\u00a0[9]: Copied! <pre>wg.run()\n</pre> wg.run() <pre>01/07/2026 03:51:49 PM &lt;183876&gt; aiida.broker.rabbitmq: [WARNING] RabbitMQ v3.9.27 is not supported and will cause unexpected problems!\nWARNING:aiida.broker.rabbitmq:RabbitMQ v3.9.27 is not supported and will cause unexpected problems!\n01/07/2026 03:51:49 PM &lt;183876&gt; aiida.broker.rabbitmq: [WARNING] It can cause long-running workflows to crash and jobs to be submitted multiple times.\nWARNING:aiida.broker.rabbitmq:It can cause long-running workflows to crash and jobs to be submitted multiple times.\n01/07/2026 03:51:49 PM &lt;183876&gt; aiida.broker.rabbitmq: [WARNING] See https://github.com/aiidateam/aiida-core/wiki/RabbitMQ-version-to-use for details.\nWARNING:aiida.broker.rabbitmq:See https://github.com/aiidateam/aiida-core/wiki/RabbitMQ-version-to-use for details.\n01/07/2026 03:51:59 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: generate_inpainting_candidates\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: generate_inpainting_candidates\n01/07/2026 03:52:02 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 250997\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 250997\n01/07/2026 03:52:09 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: generate_inpainting_candidates, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: generate_inpainting_candidates, type: PythonJob, finished.\n01/07/2026 03:52:12 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: inpainting\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: inpainting\n01/07/2026 03:52:14 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251006\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251006\n01/07/2026 03:52:38 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: inpainting, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: inpainting, type: PythonJob, finished.\n01/07/2026 03:52:41 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: inpainted_constrained_relaxation,evaluate_inpainting_rmsd_inpainting,evaluate_inpainting_match_inpainting\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: inpainted_constrained_relaxation,evaluate_inpainting_rmsd_inpainting,evaluate_inpainting_match_inpainting\n01/07/2026 03:52:46 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251015, 251019, 251023\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251015, 251019, 251023\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n01/07/2026 03:52:57 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_rmsd_inpainting, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_rmsd_inpainting, type: PythonJob, finished.\n01/07/2026 03:52:58 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_match_inpainting, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_match_inpainting, type: PythonJob, finished.\n01/07/2026 03:53:01 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: \nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: \n01/07/2026 03:53:01 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251015\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251015\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n01/07/2026 03:53:26 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: inpainted_constrained_relaxation, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: inpainted_constrained_relaxation, type: PythonJob, finished.\n01/07/2026 03:53:29 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: pre_relaxed_inpainted_full_relaxation,evaluate_inpainting_rmsd_inpainted_constrained_relaxation,evaluate_inpainting_match_inpainted_constrained_relaxation\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: pre_relaxed_inpainted_full_relaxation,evaluate_inpainting_rmsd_inpainted_constrained_relaxation,evaluate_inpainting_match_inpainted_constrained_relaxation\n01/07/2026 03:53:34 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251041, 251045, 251049\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251041, 251045, 251049\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n01/07/2026 03:53:45 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_rmsd_inpainted_constrained_relaxation, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_rmsd_inpainted_constrained_relaxation, type: PythonJob, finished.\n01/07/2026 03:53:46 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_match_inpainted_constrained_relaxation, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_match_inpainted_constrained_relaxation, type: PythonJob, finished.\n01/07/2026 03:53:49 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: \nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: \n01/07/2026 03:53:50 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251041\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251041\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n01/07/2026 03:54:04 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: pre_relaxed_inpainted_full_relaxation, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: pre_relaxed_inpainted_full_relaxation, type: PythonJob, finished.\n01/07/2026 03:54:07 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: evaluate_inpainting_rmsd_pre_relaxed_inpainted_full_relaxation,evaluate_inpainting_match_pre_relaxed_inpainted_full_relaxation\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: evaluate_inpainting_rmsd_pre_relaxed_inpainted_full_relaxation,evaluate_inpainting_match_pre_relaxed_inpainted_full_relaxation\n01/07/2026 03:54:12 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251066, 251070\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|on_wait]: Process status: Waiting for child processes: 251066, 251070\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n/home/reents_t/project/dev-mattergen-inpainting/git/dbcsi-cleanup/src/xtalpaint/aiida/data.py:315: AiidaDeprecationWarning: `PandasDataFrameData.attributes` is deprecated, use `PandasDataFrameData.base.attributes.all` instead. (this will be removed in v3)\n  handle, self.attributes.get(\"filename\")\n01/07/2026 03:54:21 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_rmsd_pre_relaxed_inpainted_full_relaxation, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_rmsd_pre_relaxed_inpainted_full_relaxation, type: PythonJob, finished.\n01/07/2026 03:54:22 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_match_pre_relaxed_inpainted_full_relaxation, type: PythonJob, finished.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|update_task_state]: Task: evaluate_inpainting_match_pre_relaxed_inpainted_full_relaxation, type: PythonJob, finished.\n01/07/2026 03:54:25 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: \nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|continue_workgraph]: tasks ready to run: \n01/07/2026 03:54:26 PM &lt;183876&gt; aiida.orm.nodes.process.workflow.workchain.WorkChainNode: [REPORT] [250993|WorkGraphEngine|finalize]: Finalize workgraph.\nREPORT:aiida.orm.nodes.process.workflow.workchain.WorkChainNode:[250993|WorkGraphEngine|finalize]: Finalize workgraph.\n</pre> In\u00a0[\u00a0]: Copied! <pre>\n</pre>"},{"location":"examples/running-wo-AiiDA/","title":"Running without AiiDA","text":"In\u00a0[24]: Copied! <pre>import yaml\nimport json\nfrom xtalpaint.inpainting.config_schema import InpaintingWorkGraphConfig\nfrom xtalpaint.data import BatchedStructures\nfrom xtalpaint.utils.relaxation_utils import relax_structures\nfrom ase.io import read\nfrom pymatgen.io.ase import AseAtomsAdaptor\nfrom IPython.display import clear_output\n</pre> import yaml import json from xtalpaint.inpainting.config_schema import InpaintingWorkGraphConfig from xtalpaint.data import BatchedStructures from xtalpaint.utils.relaxation_utils import relax_structures from ase.io import read from pymatgen.io.ase import AseAtomsAdaptor from IPython.display import clear_output In\u00a0[2]: Copied! <pre>input_structures = read(\"test-structures.extxyz\", index=':')\ninput_structures = {\n    a.info['uuid'].replace(\"-\", \"_\"): AseAtomsAdaptor.get_structure(a) for a in input_structures\n}\n</pre> input_structures = read(\"test-structures.extxyz\", index=':') input_structures = {     a.info['uuid'].replace(\"-\", \"_\"): AseAtomsAdaptor.get_structure(a) for a in input_structures } In\u00a0[3]: Copied! <pre>len(input_structures)\n</pre> len(input_structures) Out[3]: <pre>5</pre> In\u00a0[4]: Copied! <pre>param_grid = {\n    \"N_steps\": 5,\n    \"coordinates_snr\": 0.2,\n    \"n_corrector_steps\": 1,\n    \"batch_size\": 1000,\n}\n</pre> param_grid = {     \"N_steps\": 5,     \"coordinates_snr\": 0.2,     \"n_corrector_steps\": 1,     \"batch_size\": 1000, } In\u00a0[16]: Copied! <pre>ENV_ACTIVATION_CMD = \"source ~/.aiida_venvs/dev-mattergen-inpainting/bin/activate\"\nENV_ACTIVATION_CMD = \"source ~/.aiida_venvs/test-xtalpaint/bin/activate\"\n\ninputs = InpaintingWorkGraphConfig(\n    inpainting_pipeline_params={\n        \"record_trajectories\": False,\n        \"predictor_corrector\": \"baseline\",\n        \"inpainting_model_params\": param_grid,\n        # \"pretrained_name\": \"mattergen_base\",\n        'model_path': '/home/reents_t/project/test-xtalpaint/new-td-20-perc',\n        \"sampling_config_path\": \"/home/reents_t/project/test-xtalpaint/git/mattergen/sampling_conf\",\n    },\n    structures=BatchedStructures(\n        {k.replace(\"-\", \"_\"): s for k, s in input_structures.items()}\n    ),\n    gen_inpainting_candidates_params={\n        \"n_inp\": {\n            k.replace(\"-\", \"_\"): int(s.composition[\"H\"])\n            for k, s in input_structures.items()\n        },\n        \"element\": \"H\",\n        \"num_samples\": 1,\n    },\n    relax=True,\n    full_relax=True,\n    full_relax_wo_pre_relax=False,\n    relax_kwargs={\n        \"elements_to_relax\": [\"H\"],\n        \"fmax\": 0.01,\n        \"max_natoms_per_batch\": 5000,\n        \"load_path\": \"MatterSim-v1.0.0-5M.pth\",\n        \"max_n_steps\": 50,\n        \"device\": \"cuda\",\n        \"mlip\": \"mattersim\",\n        \"optimizer\": \"BFGS\",\n        \"return_initial_energies\": False,\n        \"return_initial_forces\": False,\n        \"return_final_forces\": False,\n    },\n    gen_inpainting_candidates_options={\n        \"custom_scheduler_commands\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",\n    },\n    options={\n        \"prepend_text\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",\n    },\n    evaluate_params={\"max_workers\": 5, \"metrics\": [\"match\", \"rmsd\"]},\n    evaluate=True,\n)\n</pre> ENV_ACTIVATION_CMD = \"source ~/.aiida_venvs/dev-mattergen-inpainting/bin/activate\" ENV_ACTIVATION_CMD = \"source ~/.aiida_venvs/test-xtalpaint/bin/activate\"  inputs = InpaintingWorkGraphConfig(     inpainting_pipeline_params={         \"record_trajectories\": False,         \"predictor_corrector\": \"baseline\",         \"inpainting_model_params\": param_grid,         # \"pretrained_name\": \"mattergen_base\",         'model_path': '/home/reents_t/project/test-xtalpaint/new-td-20-perc',         \"sampling_config_path\": \"/home/reents_t/project/test-xtalpaint/git/mattergen/sampling_conf\",     },     structures=BatchedStructures(         {k.replace(\"-\", \"_\"): s for k, s in input_structures.items()}     ),     gen_inpainting_candidates_params={         \"n_inp\": {             k.replace(\"-\", \"_\"): int(s.composition[\"H\"])             for k, s in input_structures.items()         },         \"element\": \"H\",         \"num_samples\": 1,     },     relax=True,     full_relax=True,     full_relax_wo_pre_relax=False,     relax_kwargs={         \"elements_to_relax\": [\"H\"],         \"fmax\": 0.01,         \"max_natoms_per_batch\": 5000,         \"load_path\": \"MatterSim-v1.0.0-5M.pth\",         \"max_n_steps\": 50,         \"device\": \"cuda\",         \"mlip\": \"mattersim\",         \"optimizer\": \"BFGS\",         \"return_initial_energies\": False,         \"return_initial_forces\": False,         \"return_final_forces\": False,     },     gen_inpainting_candidates_options={         \"custom_scheduler_commands\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",     },     options={         \"prepend_text\": f\"{ENV_ACTIVATION_CMD}\\nexport PYTHONBREAKPOINT=0\",     },     evaluate_params={\"max_workers\": 5, \"metrics\": [\"match\", \"rmsd\"]},     evaluate=True, ) In\u00a0[17]: Copied! <pre>print(f\"Processing {len(input_structures)} structures\")\n</pre> print(f\"Processing {len(input_structures)} structures\") <pre>Processing 5 structures\n</pre> In\u00a0[18]: Copied! <pre>from xtalpaint.inpainting.generate_candidates import (\n    generate_inpainting_candidates,\n)\n</pre> from xtalpaint.inpainting.generate_candidates import (     generate_inpainting_candidates, ) In\u00a0[19]: Copied! <pre># Step 1: Generate inpainting candidates\nprint(\"Running inpainting pipeline...\")\n\nn_inp_dict = inputs.gen_inpainting_candidates_params.n_inp\nelement = inputs.gen_inpainting_candidates_params.element\nnum_samples = inputs.gen_inpainting_candidates_params.num_samples\n\ninpainting_candidates = generate_inpainting_candidates(\n    structures=input_structures,\n    n_inp=n_inp_dict,\n    element=element,\n    num_samples=num_samples,\n)\n\nprint(f\"Generated {len(inpainting_candidates)} inpainted structures\")\n</pre> # Step 1: Generate inpainting candidates print(\"Running inpainting pipeline...\")  n_inp_dict = inputs.gen_inpainting_candidates_params.n_inp element = inputs.gen_inpainting_candidates_params.element num_samples = inputs.gen_inpainting_candidates_params.num_samples  inpainting_candidates = generate_inpainting_candidates(     structures=input_structures,     n_inp=n_inp_dict,     element=element,     num_samples=num_samples, )  print(f\"Generated {len(inpainting_candidates)} inpainted structures\") <pre>Running inpainting pipeline...\nGenerated 5 inpainted structures\n</pre> In\u00a0[20]: Copied! <pre>inpainting_candidates\n</pre> inpainting_candidates Out[20]: <pre>{'20acc66e_8e38_4e5e_9e7a_c2400262cdc8': Structure Summary\n Lattice\n     abc : 5.169783747 5.169783747 5.169783747\n  angles : 90.0 90.0 90.0\n  volume : 138.17107311088554\n       A : 5.169783747 0.0 0.0\n       B : 0.0 5.169783747 0.0\n       C : 0.0 0.0 5.169783747\n     pbc : True True True\n PeriodicSite: N (2.309, 4.894, 2.86) [0.4467, 0.9467, 0.5533]\n PeriodicSite: N (4.894, 2.86, 2.309) [0.9467, 0.5533, 0.4467]\n PeriodicSite: N (2.86, 2.309, 4.894) [0.5533, 0.4467, 0.9467]\n PeriodicSite: N (0.2756, 0.2756, 0.2756) [0.0533, 0.0533, 0.0533]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan],\n '47b9a869_9b1e_438b_8c93_f5ac654bfdd8': Structure Summary\n Lattice\n     abc : 4.401448665821795 4.401448665821795 7.1759779644947\n  angles : 90.0 90.0 120.19000916247398\n  volume : 120.16231769034825\n       A : 2.1944008576909 -3.8154102313683 0.0\n       B : 2.1944008576909 3.8154102313683 0.0\n       C : 0.0 0.0 7.1759779644947\n     pbc : True True True\n PeriodicSite: O (2.194, 2.549, 3.886) [0.1659, 0.8341, 0.5415]\n PeriodicSite: O (7.744e-18, 1.266, 0.2978) [-0.1659, 0.1659, 0.0415]\n PeriodicSite: O (2.194, 2.544, 6.579) [0.1666, 0.8334, 0.9168]\n PeriodicSite: O (1.254e-17, 1.272, 2.991) [-0.1666, 0.1666, 0.4168]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan],\n '662c7351_ee76_48ea_bab7_b733e1fdf607': Structure Summary\n Lattice\n     abc : 8.414296245395509 8.414296245395509 8.414296245395509\n  angles : 93.51670444494472 93.51670444494472 151.3208570539183\n  volume : 276.98877799736266\n       A : -5.7644391936362 5.7644391936362 2.0839536633569\n       B : 5.7644391936362 -5.7644391936362 2.0839536633569\n       C : 5.7644391936362 5.7644391936362 -2.0839536633569\n     pbc : True True True\n PeriodicSite: O (4.413e-16, 8.82, -0.1928) [0.7188, -0.04627, 0.7651]\n PeriodicSite: O (7.129e-17, 3.056, 1.235) [0.5613, 0.2963, 0.2651]\n PeriodicSite: O (7.664e-17, 2.709, -0.1928) [0.1887, -0.04627, 0.2349]\n PeriodicSite: O (7.102e-16, 8.473, 1.235) [1.031, 0.2963, 0.7349]\n PeriodicSite: O (3.056, 5.764, 2.277) [1.046, 0.8113, 0.7651]\n PeriodicSite: O (8.82, 5.764, 0.8491) [0.7037, 0.9688, 1.265]\n PeriodicSite: O (8.473, 5.764, 2.277) [1.046, 1.281, 1.235]\n PeriodicSite: O (2.709, 5.764, 0.8491) [0.7037, 0.4387, 0.7349]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan],\n '7fa282c5_4971_46f4_8b3b_776595a0fa06': Structure Summary\n Lattice\n     abc : 6.3321144796 6.332114479595774 6.603633127\n  angles : 90.0 90.0 120.00000000002208\n  volume : 229.3037119499634\n       A : 6.3321144796 0.0 0.0\n       B : -3.1660572398 5.483771999 0.0\n       C : 0.0 0.0 6.603633127\n     pbc : True True True\n PeriodicSite: Y (2.099, 3.636, 1.651) [0.6631, 0.6631, 0.25]\n PeriodicSite: Y (4.199, 0.0, 4.953) [0.6631, 0.0, 0.75]\n PeriodicSite: Y (-2.099, 3.636, 4.953) [-6.806e-10, 0.6631, 0.75]\n PeriodicSite: Y (-1.067, 1.848, 1.651) [7.402e-10, 0.3369, 0.25]\n PeriodicSite: Y (1.067, 1.848, 4.953) [0.3369, 0.3369, 0.75]\n PeriodicSite: Y (2.134, 0.0, 1.651) [0.3369, 0.0, 0.25]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan],\n 'c436bbf4_9aef_44a8_8960_00227f79a32f': Structure Summary\n Lattice\n     abc : 4.9620535714985 5.689428317103 4.4034011624103\n  angles : 90.0 90.0 90.0\n  volume : 124.31351070276466\n       A : 4.9620535714985 0.0 0.0\n       B : 0.0 5.689428317103 0.0\n       C : 0.0 0.0 4.4034011624103\n     pbc : True True True\n PeriodicSite: V (2.481, 1.451, 2.02) [0.5, 0.2551, 0.4587]\n PeriodicSite: V (-2.13e-06, 4.238, 2.02) [-4.293e-07, 0.7449, 0.4587]\n PeriodicSite: V (2.481, 4.238, 2.02) [0.5, 0.7449, 0.4587]\n PeriodicSite: V (2.13e-06, 1.451, 2.02) [4.293e-07, 0.2551, 0.4587]\n PeriodicSite: V (2.481, 2.845, -0.1521) [0.5, 0.5, -0.03455]\n PeriodicSite: V (0.0, 2.845, -0.1521) [0.0, 0.5, -0.03455]\n PeriodicSite: V (2.481, 0.0, -0.1605) [0.5, 0.0, -0.03644]\n PeriodicSite: V (0.0, 0.0, -0.1605) [0.0, 0.0, -0.03644]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]\n PeriodicSite: H (nan, nan, nan) [nan, nan, nan]}</pre> In\u00a0[21]: Copied! <pre>from xtalpaint.inpainting.inpainting_process import (\n    run_inpainting_pipeline,\n    run_mpi_parallel_inpainting_pipeline,\n)\n</pre> from xtalpaint.inpainting.inpainting_process import (     run_inpainting_pipeline,     run_mpi_parallel_inpainting_pipeline, ) In\u00a0[22]: Copied! <pre>USE_MPI_FOR_PARALLEL_INPAINTING = False\n\ninpainting_method = (\n    run_mpi_parallel_inpainting_pipeline\n    if USE_MPI_FOR_PARALLEL_INPAINTING\n    else run_inpainting_pipeline\n)\n</pre> USE_MPI_FOR_PARALLEL_INPAINTING = False  inpainting_method = (     run_mpi_parallel_inpainting_pipeline     if USE_MPI_FOR_PARALLEL_INPAINTING     else run_inpainting_pipeline ) In\u00a0[23]: Copied! <pre>config = inputs.inpainting_pipeline_params.model_dump(\n                exclude_none=True\n            )\n\ninpainting_outputs = run_inpainting_pipeline(\n    structures=inpainting_candidates, config=config\n)\n\nclear_output()\n</pre> config = inputs.inpainting_pipeline_params.model_dump(                 exclude_none=True             )  inpainting_outputs = run_inpainting_pipeline(     structures=inpainting_candidates, config=config )  clear_output() <pre>Converting structures to numpy:   0%|          | 0/5 [00:00&lt;?, ?it/s]</pre> <pre>INFO:mattergen.common.utils.eval_utils:Loading model from checkpoint: /home/reents_t/project/test-xtalpaint/new-td-20-perc/checkpoints/last.ckpt\n</pre> <pre>\nModel config:\nauto_resume: false\ncheckpoint_path: null\ndata_module:\n  _recursive_: true\n  _target_: mattergen.common.data.datamodule.CrystDataModule\n  average_density: 0.05771451654022283\n  batch_size:\n    train: 128\n    val: 128\n  dataset_transforms:\n  - _partial_: true\n    _target_: mattergen.common.data.dataset_transform.filter_sparse_properties\n  max_epochs: 2200\n  num_workers:\n    train: 128\n    val: 128\n  properties: []\n  root_dir: /data/user/reents_t/projects/mlip/git/mattergen/mattergen/../datasets/cache/alex_mp_20_wo_mc3d_H\n  train_dataset:\n    _target_: mattergen.common.data.dataset.CrystalDataset.from_cache_path\n    cache_path: /data/user/reents_t/projects/mlip/git/mattergen/mattergen/../datasets/cache/alex_mp_20_wo_mc3d_H/train\n    dataset_transforms:\n    - _partial_: true\n      _target_: mattergen.common.data.dataset_transform.filter_sparse_properties\n    properties: []\n    transforms:\n    - _partial_: true\n      _target_: mattergen.common.data.transform.symmetrize_lattice\n    - _partial_: true\n      _target_: mattergen.common.data.transform.set_chemical_system_string\n  transforms:\n  - _partial_: true\n    _target_: mattergen.common.data.transform.symmetrize_lattice\n  - _partial_: true\n    _target_: mattergen.common.data.transform.set_chemical_system_string\n  val_dataset:\n    _target_: mattergen.common.data.dataset.CrystalDataset.from_cache_path\n    cache_path: /data/user/reents_t/projects/mlip/git/mattergen/mattergen/../datasets/cache/alex_mp_20_wo_mc3d_H/val\n    dataset_transforms:\n    - _partial_: true\n      _target_: mattergen.common.data.dataset_transform.filter_sparse_properties\n    properties: []\n    transforms:\n    - _partial_: true\n      _target_: mattergen.common.data.transform.symmetrize_lattice\n    - _partial_: true\n      _target_: mattergen.common.data.transform.set_chemical_system_string\nlightning_module:\n  _target_: mattergen.diffusion.lightning_module.DiffusionLightningModule\n  diffusion_module:\n    _target_: xtalpaint.time_dependent.diffusion_module.TDDiffusionModule\n    corruption:\n      _target_: mattergen.diffusion.corruption.multi_corruption.MultiCorruption\n      sdes:\n        pos:\n          _target_: xtalpaint.time_dependent.corruption.TDNumAtomsVarianceAdjustedWrappedVESDE\n          limit_info_key: num_atoms\n          sigma_max: 5.0\n          wrapping_boundary: 1.0\n    loss_fn:\n      _target_: xtalpaint.time_dependent.loss.TDMaterialsLoss\n      d3pm_hybrid_lambda: 0.01\n      include_atomic_numbers: false\n      include_cell: false\n      include_pos: true\n      reduce: sum\n      weights:\n        pos: 1\n    model:\n      _target_: mattergen.denoiser.GemNetTDenoiser\n      atom_type_diffusion: mask\n      denoise_atom_types: false\n      gemnet:\n        _target_: xtalpaint.time_dependent.gemnet.TDGemNetT\n        atom_embedding:\n          _target_: mattergen.common.gemnet.layers.embedding_block.AtomEmbedding\n          emb_size: 512\n          with_mask_type: false\n        cutoff: 7.0\n        emb_size_atom: 512\n        emb_size_edge: 512\n        latent_dim: 512\n        max_cell_images_per_dim: 5\n        max_neighbors: 50\n        num_blocks: 4\n        num_targets: 1\n        otf_graph: true\n        regress_stress: true\n        scale_file: /home/reents_t/project/test-xtalpaint/git/mattergen/mattergen/common/gemnet/gemnet-dT.json\n      hidden_dim: 512\n      property_embeddings: {}\n      property_embeddings_adapt: {}\n    p_replace: 0.2\n    pre_corruption_fn:\n      _target_: mattergen.property_embeddings.SetEmbeddingType\n      dropout_fields_iid: false\n      p_unconditional: 0.2\n    t_replace: 0.001\n  optimizer_partial:\n    _partial_: true\n    _target_: torch.optim.Adam\n    lr: 0.0001\n  scheduler_partials:\n  - frequency: 1\n    interval: epoch\n    monitor: loss_train\n    scheduler:\n      _partial_: true\n      _target_: torch.optim.lr_scheduler.ReduceLROnPlateau\n      factor: 0.6\n      min_lr: 1.0e-06\n      patience: 100\n      verbose: true\n    strict: true\nload_original: false\nparams: {}\ntrainer:\n  _target_: pytorch_lightning.Trainer\n  accelerator: gpu\n  accumulate_grad_batches: 1\n  callbacks:\n  - _target_: pytorch_lightning.callbacks.EarlyStopping\n    min_delta: 0.01\n    mode: min\n    monitor: loss_val\n    patience: 20\n    strict: true\n    verbose: true\n  check_val_every_n_epoch: 5\n  devices: 4\n  gradient_clip_algorithm: value\n  gradient_clip_val: 0.5\n  max_epochs: 2200\n  num_nodes: 1\n  precision: 32\n  strategy:\n    _target_: pytorch_lightning.strategies.ddp.DDPStrategy\n    find_unused_parameters: true\n\n\nSampling config:\nsampler_partial:\n  _target_: mattergen.diffusion.sampling.classifier_free_guidance.GuidedPredictorCorrector.from_pl_module\n  'N': 5\n  eps_t: 0.2\n  _partial_: true\n  guidance_scale: 0.0\n  remove_conditioning_fn:\n    _target_: mattergen.property_embeddings.SetUnconditionalEmbeddingType\n  keep_conditioning_fn:\n    _target_: mattergen.property_embeddings.SetConditionalEmbeddingType\n  predictor_partials:\n    pos:\n      _target_: mattergen.diffusion.wrapped.wrapped_predictors_correctors.WrappedAncestralSamplingPredictor\n      _partial_: true\n  corrector_partials:\n    pos:\n      _target_: mattergen.diffusion.wrapped.wrapped_predictors_correctors.WrappedLangevinCorrector\n      _partial_: true\n      max_step_size: 1000000.0\n      snr: 0.2\n  n_steps_corrector: 1\ncondition_loader_partial:\n  _partial_: true\n  _target_: mattergen.common.data.condition_factory.get_number_of_atoms_condition_loader\n  num_atoms_distribution: ALEX_MP_20\n  batch_size: 10\n  num_samples: 10\n\n{'pos': &lt;xtalpaint.time_dependent.corruption.TDNumAtomsVarianceAdjustedWrappedVESDE object at 0x7da1cda556f0&gt;}\n</pre> <pre>Generating samples:   0%|          | 0/1 [00:00&lt;?, ?it/s]WARNING:root:Warning: batch shape is == x shape, are you trying to expand something that is already expanded?\n</pre> <pre>  0%|          | 0/5 [00:00&lt;?, ?it/s]</pre> <pre>Generating samples:   0%|          | 0/1 [00:00&lt;?, ?it/s]\n</pre> <pre>\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\nCell In[23], line 5\n      1 config = inputs.inpainting_pipeline_params.model_dump(\n      2                 exclude_none=True\n      3             )\n----&gt; 5 inpainting_outputs = run_inpainting_pipeline(\n      6     structures=inpainting_candidates, config=config\n      7 )\n      9 clear_output()\n\nFile ~/project/test-xtalpaint/git/XtalPaint/src/xtalpaint/inpainting/inpainting_process.py:329, in run_inpainting_pipeline(structures, config)\n    322 labels, structures = map(list, zip(*structures.items()))\n    324 prepared_structures = _prepare_structures(\n    325     structures,\n    326     batch_size=config[\"inpainting_model_params\"].get(\"batch_size\", 64),\n    327 )\n--&gt; 329 inpainted_structures, trajectories, mean_trajectories = _run_inpainting(\n    330     structures_dl=prepared_structures, **config\n    331 )\n    333 return _extract_outputs(\n    334     inpainted_structures,\n    335     trajectories,\n   (...)\n    338     config[\"record_trajectories\"],\n    339 )\n\nFile ~/project/test-xtalpaint/git/XtalPaint/src/xtalpaint/inpainting/inpainting_process.py:204, in _run_inpainting(predictor_corrector, structures_dl, inpainting_model_params, fix_cell, record_trajectories, pretrained_name, model_path, sampling_config_path)\n    183 \"\"\"Run the inpainting process using MatterGen.\n    184 \n    185 Args:\n   (...)\n    198     mean_trajectories is None if not recorded.\n    199 \"\"\"\n    200 sampling_config_overrides, config_overrides = _get_overrides(\n    201     inpainting_model_params, predictor_corrector, fix_cell, pretrained_name\n    202 )\n--&gt; 204 reconstructed_structures = generate_reconstructed_structures(\n    205     structures_to_reconstruct=structures_dl,\n    206     sampling_config_overrides=sampling_config_overrides,\n    207     config_overrides=config_overrides,\n    208     model_path=model_path,\n    209     pretrained_name=pretrained_name,\n    210     record_trajectories=record_trajectories,\n    211     fix_cell=fix_cell,\n    212     sampling_config_path=sampling_config_path,\n    213 )\n    215 if len(reconstructed_structures) == 2:\n    216     print(\"Not returning mean trajectories.\")\n\nFile ~/project/test-xtalpaint/git/XtalPaint/src/xtalpaint/generate_inpainting.py:298, in generate_reconstructed_structures(structures_to_reconstruct, pretrained_name, model_path, batch_size, num_batches, config_overrides, checkpoint_epoch, properties_to_condition_on, sampling_config_path, sampling_config_name, sampling_config_overrides, record_trajectories, diffusion_guidance_factor, strict_checkpoint_loading, target_compositions, fix_cell)\n    274 _sampling_config_path = (\n    275     Path(sampling_config_path)\n    276     if sampling_config_path is not None\n    277     else None\n    278 )\n    280 generator = CrystalInpaintingGenerator(\n    281     dataloader=structures_to_reconstruct,\n    282     checkpoint_info=checkpoint_info,\n   (...)\n    295     target_compositions_dict=target_compositions,\n    296 )\n--&gt; 298 return generator.generate(fix_cell=fix_cell)\n\nFile ~/project/test-xtalpaint/git/XtalPaint/src/xtalpaint/generate_inpainting.py:178, in CrystalInpaintingGenerator.generate(self, batch_size, num_batches, target_compositions_dict, fix_cell)\n    174 sampler._multi_corruption.corruptions.pop(\"atomic_numbers\", None)\n    176 print(sampler.diffusion_module.corruption.corruptions)\n--&gt; 178 generated_structures = draw_samples_from_sampler(\n    179     sampler=sampler,\n    180     condition_loader=condition_loader,\n    181     properties_to_condition_on=self.properties_to_condition_on,\n    182     record_trajectories=self.record_trajectories,\n    183     fix_cell=fix_cell,\n    184 )\n    186 return generated_structures\n\nFile ~/project/test-xtalpaint/git/XtalPaint/src/xtalpaint/generate_inpainting.py:85, in draw_samples_from_sampler(sampler, condition_loader, properties_to_condition_on, record_trajectories, fix_cell)\n     79         all_trajs_list.extend(\n     80             list_of_time_steps_to_list_of_trajectories(\n     81                 intermediate_samples\n     82             )\n     83         )\n     84     else:\n---&gt; 85         sample, mean = sampler.sample(conditioning_data, mask)\n     86     all_samples_list.extend(mean.to_data_list())\n     87 all_samples = collate(all_samples_list)\n\nFile ~/.aiida_venvs/test-xtalpaint/lib/python3.10/site-packages/torch/utils/_contextlib.py:115, in context_decorator.&lt;locals&gt;.decorate_context(*args, **kwargs)\n    112 @functools.wraps(func)\n    113 def decorate_context(*args, **kwargs):\n    114     with ctx_factory():\n--&gt; 115         return func(*args, **kwargs)\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/diffusion/sampling/pc_sampler.py:114, in PredictorCorrector.sample(self, conditioning_data, mask)\n    100 @torch.no_grad()\n    101 def sample(\n    102     self, conditioning_data: BatchedData, mask: Mapping[str, torch.Tensor] | None = None\n    103 ) -&gt; SampleAndMean:\n    104     \"\"\"Create one sample for each of a batch of conditions.\n    105     Args:\n    106         conditioning_data: batched conditioning data. Even if you think you don't want conditioning, you still need to pass a batch of conditions\n   (...)\n    112 \n    113     \"\"\"\n--&gt; 114     return self._sample_maybe_record(conditioning_data, mask=mask, record=False)[:2]\n\nFile ~/.aiida_venvs/test-xtalpaint/lib/python3.10/site-packages/torch/utils/_contextlib.py:115, in context_decorator.&lt;locals&gt;.decorate_context(*args, **kwargs)\n    112 @functools.wraps(func)\n    113 def decorate_context(*args, **kwargs):\n    114     with ctx_factory():\n--&gt; 115         return func(*args, **kwargs)\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/diffusion/sampling/pc_sampler.py:157, in PredictorCorrector._sample_maybe_record(self, conditioning_data, mask, record)\n    155 mask = {k: v.to(self._device) for k, v in mask.items()}\n    156 batch = _sample_prior(self._multi_corruption, conditioning_data, mask=mask)\n--&gt; 157 return self._denoise(batch=batch, mask=mask, record=record)\n\nFile ~/.aiida_venvs/test-xtalpaint/lib/python3.10/site-packages/torch/utils/_contextlib.py:115, in context_decorator.&lt;locals&gt;.decorate_context(*args, **kwargs)\n    112 @functools.wraps(func)\n    113 def decorate_context(*args, **kwargs):\n    114     with ctx_factory():\n--&gt; 115         return func(*args, **kwargs)\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/diffusion/sampling/pc_sampler.py:187, in PredictorCorrector._denoise(self, batch, mask, record)\n    185 if self._correctors:\n    186     for _ in range(self._n_steps_corrector):\n--&gt; 187         score = self._score_fn(batch, t)\n    188         fns = {\n    189             k: corrector.step_given_score for k, corrector in self._correctors.items()\n    190         }\n    191         samples_means: dict[str, Tuple[torch.Tensor, torch.Tensor]] = apply(\n    192             fns=fns,\n    193             broadcast={\"t\": t, \"dt\": dt},\n   (...)\n    196             batch_idx=self._multi_corruption._get_batch_indices(batch),\n    197         )\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/diffusion/sampling/classifier_free_guidance.py:72, in GuidedPredictorCorrector._score_fn(self, x, t)\n     70     return get_conditional_score()\n     71 elif abs(self._guidance_scale) &lt; 1e-15:\n---&gt; 72     return get_unconditional_score()\n     73 else:\n     74     # guided_score = guidance_factor * conditional_score + (1-guidance_factor) * unconditional_score\n     75     batch_no_condition = self._remove_conditioning_fn(x)\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/diffusion/sampling/classifier_free_guidance.py:60, in GuidedPredictorCorrector._score_fn.&lt;locals&gt;.get_unconditional_score()\n     59 def get_unconditional_score():\n---&gt; 60     return super(GuidedPredictorCorrector, self)._score_fn(\n     61         x=self._remove_conditioning_fn(x), t=t\n     62     )\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/diffusion/sampling/pc_sampler.py:94, in PredictorCorrector._score_fn(self, x, t)\n     93 def _score_fn(self, x: Diffusable, t: torch.Tensor) -&gt; Diffusable:\n---&gt; 94     return self._diffusion_module.score_fn(x, t)\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/diffusion/diffusion_module.py:129, in DiffusionModule.score_fn(self, x, t)\n    119 def score_fn(self, x: T, t: torch.Tensor) -&gt; T:\n    120     \"\"\"Calculate the score of a batch of data at a given timestep\n    121 \n    122     Args:\n   (...)\n    127         score: score of the batch of data at the given timestep\n    128     \"\"\"\n--&gt; 129     model_out: T = self.model(x, t)\n    130     fns = {k: convert_model_out_to_score for k in self.corruption.sdes.keys()}\n    132     scores = apply(\n    133         fns=fns,\n    134         model_out=model_out,\n   (...)\n    138         batch_idx=self.corruption._get_batch_indices(x),\n    139     )\n\nFile ~/.aiida_venvs/test-xtalpaint/lib/python3.10/site-packages/torch/nn/modules/module.py:1511, in Module._wrapped_call_impl(self, *args, **kwargs)\n   1509     return self._compiled_call_impl(*args, **kwargs)  # type: ignore[misc]\n   1510 else:\n-&gt; 1511     return self._call_impl(*args, **kwargs)\n\nFile ~/.aiida_venvs/test-xtalpaint/lib/python3.10/site-packages/torch/nn/modules/module.py:1520, in Module._call_impl(self, *args, **kwargs)\n   1515 # If we don't have any hooks, we want to skip the rest of the logic in\n   1516 # this function, and just call forward.\n   1517 if not (self._backward_hooks or self._backward_pre_hooks or self._forward_hooks or self._forward_pre_hooks\n   1518         or _global_backward_pre_hooks or _global_backward_hooks\n   1519         or _global_forward_hooks or _global_forward_pre_hooks):\n-&gt; 1520     return forward_call(*args, **kwargs)\n   1522 try:\n   1523     result = None\n\nFile ~/project/test-xtalpaint/mattergen-clean/mattergen/denoiser.py:248, in GemNetTDenoiser.forward(self, x, t)\n    245 if len(property_embedding_values) &gt; 0:\n    246     z_per_crystal = torch.cat([z_per_crystal, property_embedding_values], dim=-1)\n--&gt; 248 output = self.gemnet(\n    249     z=z_per_crystal,\n    250     frac_coords=frac_coords,\n    251     atom_types=atom_types,\n    252     num_atoms=num_atoms,\n    253     batch=batch,\n    254     lengths=None,\n    255     angles=None,\n    256     lattice=lattice,\n    257     # we construct the graph on the fly, hence pass None for these:\n    258     edge_index=None,\n    259     to_jimages=None,\n    260     num_bonds=None,\n    261 )\n    262 pred_atom_types = self.fc_atom(output.node_embeddings)\n    264 return get_chemgraph_from_denoiser_output(\n    265     pred_atom_types=pred_atom_types,\n    266     pred_lattice_eps=output.stress,\n   (...)\n    270     x_input=x,\n    271 )\n\nFile ~/.aiida_venvs/test-xtalpaint/lib/python3.10/site-packages/torch/nn/modules/module.py:1511, in Module._wrapped_call_impl(self, *args, **kwargs)\n   1509     return self._compiled_call_impl(*args, **kwargs)  # type: ignore[misc]\n   1510 else:\n-&gt; 1511     return self._call_impl(*args, **kwargs)\n\nFile ~/.aiida_venvs/test-xtalpaint/lib/python3.10/site-packages/torch/nn/modules/module.py:1520, in Module._call_impl(self, *args, **kwargs)\n   1515 # If we don't have any hooks, we want to skip the rest of the logic in\n   1516 # this function, and just call forward.\n   1517 if not (self._backward_hooks or self._backward_pre_hooks or self._forward_hooks or self._forward_pre_hooks\n   1518         or _global_backward_pre_hooks or _global_backward_hooks\n   1519         or _global_forward_hooks or _global_forward_pre_hooks):\n-&gt; 1520     return forward_call(*args, **kwargs)\n   1522 try:\n   1523     result = None\n\nFile ~/project/test-xtalpaint/git/XtalPaint/src/xtalpaint/time_dependent/gemnet.py:101, in TDGemNetT.forward(self, z, frac_coords, atom_types, num_atoms, batch, lengths, angles, edge_index, to_jimages, num_bonds, lattice)\n     99 if z is not None:\n    100     if z.shape[0] != h.shape[0]:\n--&gt; 101         raise ValueError(\n    102             'The TD-Paint compatible GemNetT model expects the latent '\n    103             'vector z to have the same first dimension as the number '\n    104             'of atoms.'\n    105         )\n    106     # Keep this only to emphasize the difference to the original GemNetT\n    107     z_per_atom = z\n\nValueError: The TD-Paint compatible GemNetT model expects the latent vector z to have the same first dimension as the number of atoms.</pre> In\u00a0[\u00a0]: Copied! <pre>from xtalpaint.time_dependent.gemnet import TDGemNetT\n</pre> from xtalpaint.time_dependent.gemnet import TDGemNetT In\u00a0[14]: Copied! <pre>inpainting_outputs['structures'].get_structures(strct_type='pymatgen')\n</pre> inpainting_outputs['structures'].get_structures(strct_type='pymatgen') Out[14]: <pre>{'20acc66e_8e38_4e5e_9e7a_c2400262cdc8': Structure Summary\n Lattice\n     abc : 5.1697835922241255 5.1697835922241255 5.169783592224121\n  angles : 90.00000250447799 90.00000250447799 90.00000250447816\n  volume : 138.171060700957\n       A : 5.169783592224121 0.0 -2.2597841109472938e-07\n       B : -2.2597843664143413e-07 5.169783592224116 -2.2597841109472938e-07\n       C : 0.0 0.0 5.169783592224121\n     pbc : True True True\n PeriodicSite: N (2.309, 4.894, 2.86) [0.4467, 0.9467, 0.5533]\n PeriodicSite: N (4.894, 2.86, 2.309) [0.9467, 0.5533, 0.4467]\n PeriodicSite: N (2.86, 2.309, 4.894) [0.5533, 0.4467, 0.9467]\n PeriodicSite: N (0.2756, 0.2756, 0.2756) [0.0533, 0.0533, 0.0533]\n PeriodicSite: H (1.0, 3.885, 2.78) [0.1935, 0.7514, 0.5377]\n PeriodicSite: H (3.033, 0.5016, 4.072) [0.5867, 0.09703, 0.7876]\n PeriodicSite: H (0.5171, 2.514, 3.879) [0.1, 0.4863, 0.7503]\n PeriodicSite: H (2.79, 0.9618, 2.302) [0.5397, 0.186, 0.4453]\n PeriodicSite: H (0.08463, 3.354, 2.823) [0.01637, 0.6488, 0.546]\n PeriodicSite: H (4.048, 4.275, 2.766) [0.7831, 0.8269, 0.535]\n PeriodicSite: H (3.573, 0.8306, 2.443) [0.6912, 0.1607, 0.4725]\n PeriodicSite: H (1.074, 2.255, 2.883) [0.2078, 0.4361, 0.5577]\n PeriodicSite: H (3.691, 2.022, 0.1575) [0.7139, 0.3911, 0.03046]\n PeriodicSite: H (1.858, 1.785, 5.169) [0.3594, 0.3452, 0.9998]\n PeriodicSite: H (0.7801, 0.07337, 0.9159) [0.1509, 0.01419, 0.1772]\n PeriodicSite: H (3.279, 3.464, 5.155) [0.6342, 0.67, 0.9971],\n '47b9a869_9b1e_438b_8c93_f5ac654bfdd8': Structure Summary\n Lattice\n     abc : 4.38880300521851 4.401448726654057 7.175978183746338\n  angles : 90.000002504478 90.00000250447802 119.90499541135148\n  volume : 120.16235834626013\n       A : 4.388803005218506 0.0 -1.9184066957222967e-07\n       B : -2.1944008875261014 3.8154102843847926 -1.9239342918808688e-07\n       C : 0.0 0.0 7.175978183746338\n     pbc : True True True\n PeriodicSite: O (2.194, 2.549, 3.886) [0.8341, 0.6681, 0.5415]\n PeriodicSite: O (2.041e-07, 1.266, 0.2978) [0.1659, 0.3319, 0.0415]\n PeriodicSite: O (2.194, 2.544, 6.579) [0.8334, 0.6667, 0.9168]\n PeriodicSite: O (2.05e-07, 1.272, 2.991) [0.1666, 0.3333, 0.4168]\n PeriodicSite: H (-0.1279, 3.659, 6.497) [0.4504, 0.959, 0.9053]\n PeriodicSite: H (1.932, 1.894, 6.591) [0.6884, 0.4964, 0.9184]\n PeriodicSite: H (2.693, 0.4954, 5.701) [0.6785, 0.1299, 0.7945]\n PeriodicSite: H (0.9313, 1.986, 7.078) [0.4724, 0.5205, 0.9864]\n PeriodicSite: H (3.617, 0.776, 0.1137) [0.9259, 0.2034, 0.01585]\n PeriodicSite: H (-1.225, 2.952, 6.751) [0.1077, 0.7737, 0.9407]\n PeriodicSite: H (1.877, 2.83, 4.877) [0.7984, 0.7417, 0.6797]\n PeriodicSite: H (0.1163, 1.131, 6.242) [0.1747, 0.2965, 0.8698],\n '662c7351_ee76_48ea_bab7_b733e1fdf607': Structure Summary\n Lattice\n     abc : 4.167909392982183 8.414297301182946 8.41429615020752\n  angles : 86.48328861312336 75.66042875469425 75.66042198607414\n  volume : 276.98893913632514\n       A : 4.038057804107666 0.0 1.0322586297988892\n       B : 2.0190288528503957 8.152148872105393 0.5161301493644714\n       C : 0.0 0.0 8.41429615020752\n     pbc : True True True\n PeriodicSite: O (0.6612, 1.915, 6.606) [0.04627, 0.2349, 0.7651]\n PeriodicSite: O (4.326, 5.991, 3.336) [0.7037, 0.7349, 0.2651]\n PeriodicSite: O (1.732, 6.237, 2.419) [0.04627, 0.7651, 0.2349]\n PeriodicSite: O (3.377, 2.161, 7.047) [0.7037, 0.2651, 0.7349]\n PeriodicSite: O (3.377, 1.915, 2.84) [0.7188, 0.2349, 0.2349]\n PeriodicSite: O (3.751, 5.991, 7.143) [0.5613, 0.7349, 0.7349]\n PeriodicSite: O (2.307, 6.237, 7.027) [0.1887, 0.7651, 0.7651]\n PeriodicSite: O (0.6612, 2.161, 2.399) [0.03121, 0.2651, 0.2651]\n PeriodicSite: H (1.069, 2.064, 4.164) [0.1381, 0.2532, 0.4623]\n PeriodicSite: H (4.283, 6.41, 8.256) [0.6675, 0.7863, 0.8511]\n PeriodicSite: H (3.153, 6.595, 6.226) [0.3762, 0.809, 0.6441]\n PeriodicSite: H (1.228, 3.129, 7.099) [0.1121, 0.3838, 0.8064]\n PeriodicSite: H (0.9039, 0.5538, 2.695) [0.1899, 0.06794, 0.2928]\n PeriodicSite: H (1.622, 3.405, 1.922) [0.193, 0.4177, 0.1791]\n PeriodicSite: H (3.576, 3.679, 2.863) [0.66, 0.4513, 0.2316]\n PeriodicSite: H (3.334, 2.291, 5.648) [0.6851, 0.2811, 0.5699],\n '7fa282c5_4971_46f4_8b3b_776595a0fa06': Structure Summary\n Lattice\n     abc : 6.332112789154059 6.332114696502691 6.603632926940918\n  angles : 90.00000250447809 90.00000250447808 119.99999014147143\n  volume : 229.303674421453\n       A : 6.332112789154053 0.0 -2.767854425655969e-07\n       B : -3.1660564046927258 5.483772731611829 -2.767855278307252e-07\n       C : 0.0 0.0 6.603632926940918\n     pbc : True True True\n PeriodicSite: Y (2.134, 0.0, 4.953) [0.3369, 0.0, 0.75]\n PeriodicSite: Y (1.067, 1.848, 1.651) [0.3369, 0.3369, 0.25]\n PeriodicSite: Y (-2.099, 3.636, 1.651) [6.806e-10, 0.6631, 0.25]\n PeriodicSite: Y (-1.067, 1.848, 4.953) [0.0, 0.3369, 0.75]\n PeriodicSite: Y (4.199, 4.059e-09, 1.651) [0.6631, 7.402e-10, 0.25]\n PeriodicSite: Y (2.099, 3.636, 4.953) [0.6631, 0.6631, 0.75]\n PeriodicSite: H (3.15, 1.752, 4.848) [0.6572, 0.3195, 0.7341]\n PeriodicSite: H (0.4701, 2.696, 6.053) [0.3201, 0.4917, 0.9166]\n PeriodicSite: H (-0.03274, 0.1909, 1.806) [0.01223, 0.0348, 0.2735]\n PeriodicSite: H (-1.976, 3.817, 5.611) [0.03597, 0.696, 0.8497]\n PeriodicSite: H (4.78, 0.1132, 6.239) [0.7653, 0.02065, 0.9448]\n PeriodicSite: H (2.249, 3.828, 2.821) [0.7041, 0.698, 0.4272]\n PeriodicSite: H (3.885, 1.989, 2.709) [0.7948, 0.3627, 0.4102]\n PeriodicSite: H (0.893, 1.913, 4.326) [0.3155, 0.3489, 0.6551]\n PeriodicSite: H (1.422, 2.137, 3.569) [0.4194, 0.3897, 0.5404]\n PeriodicSite: H (6.255, 0.03513, 4.606) [0.991, 0.006407, 0.6975]\n PeriodicSite: H (0.8428, 5.394, 3.953) [0.6249, 0.9835, 0.5987]\n PeriodicSite: H (-1.031, 3.605, 3.669) [0.1658, 0.6573, 0.5556]\n PeriodicSite: H (-0.01093, 3.839, 1.495) [0.3483, 0.7001, 0.2264]\n PeriodicSite: H (2.11, 0.172, 2.377) [0.349, 0.03137, 0.36]\n PeriodicSite: H (3.165, 2.702, 6.593) [0.7462, 0.4928, 0.9983]\n PeriodicSite: H (2.485, 0.8155, 0.3001) [0.4668, 0.1487, 0.04545]\n PeriodicSite: H (5.153, 2.037, 0.7442) [0.9995, 0.3715, 0.1127]\n PeriodicSite: H (2.063, 3.722, 0.8681) [0.6652, 0.6787, 0.1315],\n 'c436bbf4_9aef_44a8_8960_00227f79a32f': Structure Summary\n Lattice\n     abc : 4.403401374816899 4.962053775787357 5.689428329467773\n  angles : 90.00000250447805 90.00000250447815 90.00000250447816\n  volume : 124.31352208745227\n       A : 4.4034013748168945 0.0 -1.924787937923611e-07\n       B : -2.1689827722570944e-07 4.962053775787348 -2.1689825757675862e-07\n       C : 0.0 0.0 5.689428329467773\n     pbc : True True True\n PeriodicSite: V (2.02, 2.481, 1.451) [0.4587, 0.5, 0.2551]\n PeriodicSite: V (2.02, 4.962, 4.238) [0.4587, 1.0, 0.7449]\n PeriodicSite: V (2.02, 2.481, 4.238) [0.4587, 0.5, 0.7449]\n PeriodicSite: V (2.02, 2.13e-06, 1.451) [0.4587, 4.293e-07, 0.2551]\n PeriodicSite: V (4.251, 2.481, 2.845) [0.9654, 0.5, 0.5]\n PeriodicSite: V (4.251, 0.0, 2.845) [0.9654, 0.0, 0.5]\n PeriodicSite: V (4.243, 2.481, -2.939e-07) [0.9636, 0.5, 0.0]\n PeriodicSite: V (4.243, 0.0, -1.855e-07) [0.9636, 0.0, 0.0]\n PeriodicSite: H (3.983, 0.839, 0.9776) [0.9046, 0.1691, 0.1718]\n PeriodicSite: H (0.5064, 2.343, 1.471) [0.115, 0.4722, 0.2585]\n PeriodicSite: H (1.565, 4.333, 3.258) [0.3554, 0.8732, 0.5727]\n PeriodicSite: H (3.724, 4.335, 4.633) [0.8457, 0.8736, 0.8142]\n PeriodicSite: H (2.436, 1.522, 3.406) [0.5532, 0.3067, 0.5986]\n PeriodicSite: H (1.776, 3.419, 2.246) [0.4032, 0.6889, 0.3947]}</pre> In\u00a0[15]: Copied! <pre>from xtalpaint.utils.relaxation_utils import relax_structures\n</pre> from xtalpaint.utils.relaxation_utils import relax_structures In\u00a0[16]: Copied! <pre>relax_kwargs = inputs.relax_kwargs.model_dump()\nprint(json.dumps(relax_kwargs, indent=4))\n\nstructure_labels, inpainted_structures = map(\n    list,\n    zip(\n        *inpainting_outputs[\"structures\"].get_structures(strct_type=\"pymatgen\").items()\n    ),\n)\n\nif inputs.relax:\n    constrained_relaxation_outputs = relax_structures(\n        structures=inpainted_structures,\n        **relax_kwargs,\n    )\nif inputs.full_relax:\n    relax_kwargs.pop('elements_to_relax', None)\n    full_relaxation_outputs = relax_structures(\n        structures=inpainted_structures,\n        **relax_kwargs,\n    )\n\nconstrained_relaxation_structures = dict(\n    zip(\n        structure_labels, constrained_relaxation_outputs[0]\n    )\n)\n\nfull_relaxation_structures = dict(\n    zip(\n        structure_labels, full_relaxation_outputs[0]\n    )\n)\n</pre> relax_kwargs = inputs.relax_kwargs.model_dump() print(json.dumps(relax_kwargs, indent=4))  structure_labels, inpainted_structures = map(     list,     zip(         *inpainting_outputs[\"structures\"].get_structures(strct_type=\"pymatgen\").items()     ), )  if inputs.relax:     constrained_relaxation_outputs = relax_structures(         structures=inpainted_structures,         **relax_kwargs,     ) if inputs.full_relax:     relax_kwargs.pop('elements_to_relax', None)     full_relaxation_outputs = relax_structures(         structures=inpainted_structures,         **relax_kwargs,     )  constrained_relaxation_structures = dict(     zip(         structure_labels, constrained_relaxation_outputs[0]     ) )  full_relaxation_structures = dict(     zip(         structure_labels, full_relaxation_outputs[0]     ) )  <pre>{\n    \"load_path\": \"MatterSim-v1.0.0-5M.pth\",\n    \"fmax\": 0.01,\n    \"elements_to_relax\": [\n        \"H\"\n    ],\n    \"max_natoms_per_batch\": 5000,\n    \"max_n_steps\": 50,\n    \"device\": \"cuda\",\n    \"filter\": null,\n    \"optimizer\": \"BFGS\",\n    \"mlip\": \"mattersim\",\n    \"return_initial_energies\": false,\n    \"return_initial_forces\": false,\n    \"return_final_forces\": false\n}\n2026-01-07 15:38:28.324 | INFO     | mattersim.forcefield.potential:from_checkpoint:891 - Loading the pre-trained mattersim-v1.0.0-5M.pth model\n  0%|          | 0/5 [00:00&lt;?, ?it/s]</pre> <pre>/home/reents_t/.aiida_venvs/dev-mattergen-inpainting/lib/python3.10/site-packages/mattersim/applications/batch_relax.py:80: FutureWarning: Please use atoms.calc = calc\n  atoms.set_calculator(DummyBatchCalculator())\n</pre> <pre>100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 5/5 [00:33&lt;00:00,  6.73s/it]\n2026-01-07 15:39:02.189 | INFO     | mattersim.forcefield.potential:from_checkpoint:891 - Loading the pre-trained mattersim-v1.0.0-5M.pth model\n100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 5/5 [00:49&lt;00:00,  9.90s/it]\n</pre> In\u00a0[17]: Copied! <pre>from xtalpaint.eval import evaluate_inpainting\nimport pandas as pd\n</pre> from xtalpaint.eval import evaluate_inpainting import pandas as pd In\u00a0[18]: Copied! <pre>rmsd_inpainted_structures = evaluate_inpainting(\n    inpainted_structures=inpainting_outputs[\"structures\"],\n    reference_structures=input_structures,\n    metric=\"rmsd\",\n    max_workers=3,\n    normalization_element='H',\n)\n\nmatches_inpainted_structures = evaluate_inpainting(\n    inpainted_structures=inpainting_outputs[\"structures\"],\n    reference_structures=input_structures,\n    metric=\"match\",\n    max_workers=3,\n)\n\ninpainted_evaluation = pd.merge(\n    rmsd_inpainted_structures, matches_inpainted_structures, left_index=True, right_index=True\n)\n\nrmsd_constrained_relaxation = evaluate_inpainting(\n    inpainted_structures=constrained_relaxation_structures,\n    reference_structures=input_structures,\n    metric=\"rmsd\",\n    max_workers=3,\n    normalization_element='H',\n)\nmatches_constrained_relaxation = evaluate_inpainting(\n    inpainted_structures=constrained_relaxation_structures,\n    reference_structures=input_structures,\n    metric=\"match\",\n    max_workers=3,\n)\n\nconstrained_relaxation_evaluation = pd.merge(\n    rmsd_constrained_relaxation, matches_constrained_relaxation, left_index=True, right_index=True\n)\n</pre> rmsd_inpainted_structures = evaluate_inpainting(     inpainted_structures=inpainting_outputs[\"structures\"],     reference_structures=input_structures,     metric=\"rmsd\",     max_workers=3,     normalization_element='H', )  matches_inpainted_structures = evaluate_inpainting(     inpainted_structures=inpainting_outputs[\"structures\"],     reference_structures=input_structures,     metric=\"match\",     max_workers=3, )  inpainted_evaluation = pd.merge(     rmsd_inpainted_structures, matches_inpainted_structures, left_index=True, right_index=True )  rmsd_constrained_relaxation = evaluate_inpainting(     inpainted_structures=constrained_relaxation_structures,     reference_structures=input_structures,     metric=\"rmsd\",     max_workers=3,     normalization_element='H', ) matches_constrained_relaxation = evaluate_inpainting(     inpainted_structures=constrained_relaxation_structures,     reference_structures=input_structures,     metric=\"match\",     max_workers=3, )  constrained_relaxation_evaluation = pd.merge(     rmsd_constrained_relaxation, matches_constrained_relaxation, left_index=True, right_index=True ) <pre> 80%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588  | 4/5 [00:00&lt;00:00, 13.49it/s]\n 80%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588  | 4/5 [00:00&lt;00:00, 27.33it/s]\n 80%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588  | 4/5 [00:00&lt;00:00, 15.04it/s]\n 80%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588  | 4/5 [00:00&lt;00:00, 31.99it/s]\n</pre> In\u00a0[19]: Copied! <pre>inpainted_evaluation\n</pre> inpainted_evaluation Out[19]: rmsd match keys 20acc66e_8e38_4e5e_9e7a_c2400262cdc8 1.184509 False 47b9a869_9b1e_438b_8c93_f5ac654bfdd8 1.319913 False 662c7351_ee76_48ea_bab7_b733e1fdf607 1.804719 False 7fa282c5_4971_46f4_8b3b_776595a0fa06 0.813573 False c436bbf4_9aef_44a8_8960_00227f79a32f 1.317161 False In\u00a0[20]: Copied! <pre>constrained_relaxation_evaluation\n</pre> constrained_relaxation_evaluation Out[20]: rmsd match keys 20acc66e_8e38_4e5e_9e7a_c2400262cdc8 0.783026 False 47b9a869_9b1e_438b_8c93_f5ac654bfdd8 0.326994 True 662c7351_ee76_48ea_bab7_b733e1fdf607 2.046668 False 7fa282c5_4971_46f4_8b3b_776595a0fa06 0.017497 True c436bbf4_9aef_44a8_8960_00227f79a32f 1.001336 False In\u00a0[\u00a0]: Copied! <pre>\n</pre>"},{"location":"examples/running-wo-AiiDA/#running-the-inpainting-workflow-without-aiida","title":"Running the inpainting workflow without AiiDA\u00b6","text":""},{"location":"examples/running-wo-AiiDA/#generate-inpainting-candidates","title":"Generate inpainting candidates\u00b6","text":""},{"location":"examples/running-wo-AiiDA/#run-inpainting","title":"Run inpainting\u00b6","text":""},{"location":"examples/running-wo-AiiDA/#relax-structures","title":"Relax structures\u00b6","text":""},{"location":"examples/running-wo-AiiDA/#evaluate-the-inpainted-structures-with-repspect-to-the-initial-reference","title":"Evaluate the inpainted structures with repspect to the initial reference\u00b6","text":""}]}